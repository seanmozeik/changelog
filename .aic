# changelog Release Configuration

[release]
# Clean and create dist directory
rm -rf dist && mkdir -p dist


# Build for all platforms
bun build ./src/index.ts --compile --target=bun-darwin-arm64 --outfile dist/changelog-darwin-arm64 --minify
bun build ./src/index.ts --compile --target=bun-darwin-x64 --outfile dist/changelog-darwin-x64 --minify
bun build ./src/index.ts --compile --target=bun-linux-x64 --outfile dist/changelog-linux-x64 --minify
bun build ./src/index.ts --compile --target=bun-linux-arm64 --outfile dist/changelog-linux-arm64 --minify
bun build ./src/index.ts --compile --target=bun-windows-x64 --outfile dist/changelog-windows-x64.exe --minify

# Clean up bun build artifacts
rm -f ./.*bun-build

# Create tar.gz archives for Unix platforms
cd dist && for f in changelog-darwin-* changelog-linux-*; do [ -f "$f" ] && tar -czvf "${f}.tar.gz" "$f" && rm "$f"; done

# Create zip for Windows
cd dist && [ -f "changelog-windows-x64.exe" ] && zip changelog-windows-x64.zip changelog-windows-x64.exe && rm changelog-windows-x64.exe

# Generate checksums
bun -e "import{readdir}from'fs/promises';for(const f of(await readdir('dist')).filter(f=>f.endsWith('.tar.gz')||f.endsWith('.zip'))){console.log(new Bun.CryptoHasher('sha256').update(await Bun.file('dist/'+f).arrayBuffer()).digest('hex')+'  '+f)}" > dist/checksums.txt && cat dist/checksums.txt

[publish]
# Create GitHub release with binaries
gh release create "v$(bun -p "require('./package.json').version")" dist/*.tar.gz dist/*.zip dist/checksums.txt --title "v$(bun -p "require('./package.json').version")" --notes "$(aic changelog-latest)"

# Update Homebrew formula with new version and SHA256 checksums
VERSION=$(bun -p "require('./package.json').version") && \
SHA_DARWIN_ARM64=$(bun -e "console.log(new Bun.CryptoHasher('sha256').update(await Bun.file('dist/changelog-darwin-arm64.tar.gz').arrayBuffer()).digest('hex'))") && \
SHA_DARWIN_X64=$(bun -e "console.log(new Bun.CryptoHasher('sha256').update(await Bun.file('dist/changelog-darwin-x64.tar.gz').arrayBuffer()).digest('hex'))") && \
SHA_LINUX_ARM64=$(bun -e "console.log(new Bun.CryptoHasher('sha256').update(await Bun.file('dist/changelog-linux-arm64.tar.gz').arrayBuffer()).digest('hex'))") && \
SHA_LINUX_X64=$(bun -e "console.log(new Bun.CryptoHasher('sha256').update(await Bun.file('dist/changelog-linux-x64.tar.gz').arrayBuffer()).digest('hex'))") && \
sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/changelog.rb && \
awk -v da="$SHA_DARWIN_ARM64" -v dx="$SHA_DARWIN_X64" -v la="$SHA_LINUX_ARM64" -v lx="$SHA_LINUX_X64" '/darwin-arm64\.tar\.gz/{found="da"} /darwin-x64\.tar\.gz/{found="dx"} /linux-arm64\.tar\.gz/{found="la"} /linux-x64\.tar\.gz/{found="lx"} /sha256/{if(found=="da"){sub(/sha256 ".*"/, "sha256 \""da"\"")} else if(found=="dx"){sub(/sha256 ".*"/, "sha256 \""dx"\"")} else if(found=="la"){sub(/sha256 ".*"/, "sha256 \""la"\"")} else if(found=="lx"){sub(/sha256 ".*"/, "sha256 \""lx"\"")}} {print}' Formula/changelog.rb > /tmp/changelog.rb && mv /tmp/changelog.rb Formula/changelog.rb

# Copy formula to tap and commit
cp Formula/changelog.rb ~/workspace/tap/Formula/changelog.rb && \
cd ~/workspace/tap && \
git add Formula/changelog.rb && \
git commit -m "changelog $(bun -p "require('$OLDPWD/package.json').version")" && \
git push
